"""Signals for Panorama SSOT app."""
# Import signals if needed in the future
# This file is imported in __init__.py ready() method
# pylint: disable=duplicate-code

from django.conf import settings
from nautobot.core.signals import nautobot_database_ready
from nautobot.extras.choices import (
    CustomFieldTypeChoices,
    RelationshipTypeChoices,
    SecretsGroupAccessTypeChoices,
    SecretsGroupSecretTypeChoices,
)

from nautobot_panorama_ssot.constant import TAG_COLOR

#config = settings.PLUGINS_CONFIG["nautobot_panorama_ssot"]
config = settings.PLUGINS_CONFIG.get("nautobot_panorama_ssot", {})


def register_signals(sender):
    """Register signals for Panorama integration."""
    nautobot_database_ready.connect(nautobot_database_ready_callback, sender=sender)


def nautobot_database_ready_callback(sender, *, apps, **kwargs):  # pylint: disable=unused-argument,too-many-locals,too-many-statements
    """Create Tag and CustomField to note System of Record for SSoT.

    Callback function triggered by the nautobot_database_ready signal when the Nautobot database is fully ready.
    """
    # pylint: disable=invalid-name
    ContentType = apps.get_model("contenttypes", "ContentType")
    CustomField = apps.get_model("extras", "CustomField")
    Tag = apps.get_model("extras", "Tag")
    Relationship = apps.get_model("extras", "Relationship")
    ExternalIntegration = apps.get_model("extras", "ExternalIntegration")
    Secret = apps.get_model("extras", "Secret")
    SecretsGroup = apps.get_model("extras", "SecretsGroup")
    SecretsGroupAssociation = apps.get_model("extras", "SecretsGroupAssociation")
    Status = apps.get_model("extras", "Status")
    SSOTPanoramaConfig = apps.get_model("nautobot_panorama_ssot", "SSOTPanoramaConfig")

    tag_sync_from_panorama, _ = Tag.objects.get_or_create(
        name="SSoT Synced from Panorama",
        defaults={
            "name": "SSoT Synced from Panorama",
            "description": "Object synced at some point from Panorama",
            "color": TAG_COLOR,
        },
    )

    # Migrate existing configuration to a configuration object
    if not SSOTPanoramaConfig.objects.exists():
        # Get or create default status
        default_status_name = str(config.get("panorama_default_status", "Active"))
        found_status = Status.objects.filter(name=default_status_name)
        if found_status.exists():
            default_status = found_status.first()
        else:
            # Try to get "Active" status as fallback
            default_status = Status.objects.filter(name="Active").first()
            if not default_status:
                # Create a default status if none exists
            default_status, _ = Status.objects.get_or_create(
                name="PanoramaDevStaging",
                defaults={
                    "description": "Default status for Panorama SSOT",
                }
            )

        try:
            panorama_request_timeout = int(config.get("panorama_request_timeout", 60))
        except ValueError:
            panorama_request_timeout = 60

        secrets_group, _ = SecretsGroup.objects.get_or_create(name="PanoramaSSOTDefaultSecretGroup")
        panorama_username, _ = Secret.objects.get_or_create(
            name="Panorama Username - Default",
            defaults={
                "provider": "environment-variable",
                "parameters": {"variable": "NAUTOBOT_PANORAMA_SSOT_USERNAME"},
            },
        )
        panorama_password, _ = Secret.objects.get_or_create(
            name="Panorama Password - Default",
            defaults={
                "provider": "environment-variable",
                "parameters": {"variable": "NAUTOBOT_PANORAMA_SSOT_PASSWORD"},
            },
        )
        SecretsGroupAssociation.objects.get_or_create(
            secrets_group=secrets_group,
            access_type=SecretsGroupAccessTypeChoices.TYPE_HTTP,
            secret_type=SecretsGroupSecretTypeChoices.TYPE_USERNAME,
            defaults={
                "secret": panorama_username,
            },
        )
        SecretsGroupAssociation.objects.get_or_create(
            secrets_group=secrets_group,
            access_type=SecretsGroupAccessTypeChoices.TYPE_HTTP,
            secret_type=SecretsGroupSecretTypeChoices.TYPE_TOKEN,
            defaults={
                "secret": panorama_token,
            },
        )
        external_integration, _ = ExternalIntegration.objects.get_or_create(
            name="DefaultPanoramaInstance",
            defaults={
                "remote_url": str(config.get("panorama_url", "https://panorama.replace.me.local")),
                "secrets_group": secrets_group,
                "verify_ssl": bool(config.get("panorama_verify_ssl", True)),
                "timeout": panorama_request_timeout,
            },
        )

        SSOTPanoramaConfig.objects.create(
            name="PanoramaConfigDefault",
            description="Auto-generated default configuration.",
            default_status=default_status,
            panorama_instance=external_integration,
            enable_sync_to_nautobot=True,
        )


